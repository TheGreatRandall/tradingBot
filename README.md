# Auto Trading Bot

An automated stock trading bot built with Python that executes trades based on technical analysis strategies using the Alpaca API.

---

## Table of Contents

- [Overview](#overview)
- [Architecture](#architecture)
- [Workflow](#workflow)
- [Key Components](#key-components)
- [Installation](#installation)
- [Configuration](#configuration)
- [Running the Bot](#running-the-bot)
- [Backtesting](#backtesting)
- [Risk Management](#risk-management)
- [Troubleshooting](#troubleshooting)

---

## Overview

This trading bot automates stock trading using technical analysis strategies. It connects to Alpaca's paper trading API (or live trading) to execute trades based on signals generated by configurable strategies.

**Features:**
- Real-time market data integration
- Moving Average Crossover strategy (extensible)
- Automated risk management with position sizing
- Stop-loss and take-profit automation
- Backtesting engine for strategy validation
- Discord/Telegram notifications
- Comprehensive logging

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         MAIN.PY                                  │
│                    (Orchestrator)                                │
└─────────────────────┬───────────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┬─────────────┐
        ▼             ▼             ▼             ▼
┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐
│  BROKER   │  │   DATA    │  │ STRATEGY  │  │   RISK    │
│  MODULE   │  │  MODULE   │  │  ENGINE   │  │  MANAGER  │
└─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘
      │              │              │              │
      ▼              ▼              ▼              ▼
┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐
│  Alpaca   │  │ Historical│  │    MA     │  │  Position │
│   API     │  │   Data    │  │ Crossover │  │  Sizing   │
│           │  │  + Live   │  │  + RSI    │  │  Limits   │
└───────────┘  └───────────┘  └───────────┘  └───────────┘
```

---

## Workflow

### Trading Loop Workflow

```
┌──────────────────────────────────────────────────────────────┐
│                    TRADING LOOP (60s interval)                │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  Get Account &  │
                    │   Positions     │
                    └────────┬────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  Check Risk     │──── Blocked? ──► Skip Iteration
                    │    Status       │
                    └────────┬────────┘
                              │ OK
                              ▼
                    ┌─────────────────┐
                    │ Check Stop-Loss │
                    │  / Take-Profit  │──── Triggered? ──► Close Position
                    └────────┬────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │  FOR EACH SYMBOL IN WATCHLIST │
              └───────────────┬───────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ Fetch Historical│
                    │     Data        │
                    └────────┬────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │    Generate     │
                    │     Signal      │
                    └────────┬────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
         ┌────────┐      ┌────────┐      ┌────────┐
         │  BUY   │      │  SELL  │      │  HOLD  │
         └───┬────┘      └───┬────┘      └────────┘
              │               │
              ▼               ▼
        ┌──────────┐   ┌──────────┐
        │ Validate │   │  Close   │
        │  & Size  │   │ Position │
        └────┬─────┘   └──────────┘
              │
              ▼
        ┌──────────┐
        │  Submit  │
        │  Order   │
        └──────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   Sleep 60s     │
                    └─────────────────┘
```

### Signal Generation Flow

```
Historical Data (100 bars)
         │
         ▼
┌─────────────────────────┐
│  Calculate Indicators   │
│  - SMA Fast (10-period) │
│  - SMA Slow (20-period) │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│   Detect Crossover      │
│                         │
│  Fast > Slow (was <=)   │──► BUY Signal
│  Fast < Slow (was >=)   │──► SELL Signal
│  No crossover           │──► HOLD
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  Calculate Strength     │
│  - Momentum (MA diff)   │
│  - Volume confirmation  │
│  - Trend alignment      │
└─────────────────────────┘
```

---

## Key Components

### 1. Broker Module (`src/broker/`)

Handles all communication with the Alpaca trading API.

```python
# src/broker/alpaca.py
class AlpacaBroker(BaseBroker):
    """
    Alpaca Markets broker implementation.

    Key Methods:
    - connect()          : Authenticate with Alpaca API
    - get_account()      : Fetch account balance, buying power
    - get_positions()    : List all open positions
    - submit_order()     : Place buy/sell orders
    - close_position()   : Close a specific position
    """
```

**Order Types Supported:**
- `MARKET` - Execute immediately at market price
- `LIMIT` - Execute at specified price or better
- `STOP` - Trigger market order when price hits stop
- `STOP_LIMIT` - Trigger limit order when price hits stop

### 2. Data Module (`src/data/`)

Fetches historical and real-time market data.

```python
# src/data/historical.py
class HistoricalDataLoader:
    """
    Loads OHLCV data from Alpaca or Yahoo Finance.

    Key Methods:
    - get_bars(symbol, timeframe, limit)  : Fetch historical bars
    - get_multiple_bars(symbols, ...)     : Fetch for multiple symbols

    Timeframes: 1Min, 5Min, 15Min, 1H, 1D
    """
```

**Data Flow:**
```
Request → Alpaca API → DataFrame
              │
              ▼ (fallback if fails)
         Yahoo Finance → DataFrame
```

### 3. Strategy Engine (`src/strategy/`)

Generates trading signals based on technical analysis.

```python
# src/strategy/ma_crossover.py
class MACrossoverStrategy(BaseStrategy):
    """
    Moving Average Crossover Strategy.

    Parameters:
    - fast_period: 10 (short-term trend)
    - slow_period: 20 (long-term trend)
    - stop_loss_pct: 2%
    - take_profit_pct: 5%

    Signal Logic:
    - BUY:  Fast MA crosses ABOVE Slow MA
    - SELL: Fast MA crosses BELOW Slow MA
    - HOLD: No crossover detected
    """
```

**Strategy Interface:**
```python
class BaseStrategy(ABC):
    @abstractmethod
    def calculate_indicators(self, df: DataFrame) -> DataFrame:
        """Add technical indicators to price data."""
        pass

    @abstractmethod
    def generate_signal(self, df: DataFrame, symbol: str) -> Signal:
        """Generate BUY/SELL/HOLD signal."""
        pass
```

### 4. Risk Manager (`src/risk/`)

Enforces risk limits and position sizing.

```python
# src/risk/manager.py
class RiskManager:
    """
    Risk management system.

    Limits (configurable in .env):
    - max_position_size_pct: 5% of portfolio per trade
    - max_positions: 10 concurrent positions
    - max_daily_loss_pct: 5% daily loss limit
    - max_drawdown_pct: 15% triggers kill switch

    Key Methods:
    - get_risk_status()    : Check if trading is allowed
    - validate_signal()    : Approve/reject trade signals
    - calculate_shares()   : Determine position size
    """
```

**Risk Check Flow:**
```
Signal → Daily Loss Check → Weekly Loss Check → Drawdown Check
           │                    │                    │
           ▼                    ▼                    ▼
        > 5%?               > 10%?               > 15%?
           │                    │                    │
           ▼                    ▼                    ▼
        BLOCK               BLOCK            KILL SWITCH
```

### 5. Order Manager (`src/execution/`)

Executes trades and manages order lifecycle.

```python
# src/execution/order_manager.py
class OrderManager:
    """
    Handles order execution and tracking.

    Key Methods:
    - execute_signal()              : Convert signal to order
    - check_stop_loss_take_profit() : Monitor exit conditions
    - update_pending_orders()       : Track order status
    """
```

### 6. Backtest Engine (`backtest/`)

Tests strategies against historical data.

```python
# backtest/engine.py
class BacktestEngine:
    """
    Backtesting framework.

    Features:
    - Commission simulation (0.1%)
    - Slippage simulation (0.1%)
    - Performance metrics (Sharpe, drawdown, win rate)

    Key Methods:
    - run(strategy, data, symbol)  : Execute backtest
    - print_results(result)        : Display metrics
    """
```

---

## Installation

### Prerequisites

- Python 3.10+
- Alpaca account (free at https://alpaca.markets)

### Step 1: Clone/Setup Project

```bash
cd /home/congrat/app
```

### Step 2: Install Dependencies

```bash
# If venv is available:
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# If venv not available (Debian/Ubuntu):
python3 -m pip install --user --break-system-packages -r requirements.txt
```

### Step 3: Configure Environment

```bash
cp .env.example .env
nano .env  # Edit with your API keys
```

---

## Configuration

### Environment Variables (`.env`)

```bash
# Required: Alpaca API Credentials
ALPACA_API_KEY=PKXXXXXXXXXXXXXXXXXX
ALPACA_SECRET_KEY=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
ALPACA_BASE_URL=https://paper-api.alpaca.markets

# Environment: paper or live
ENVIRONMENT=paper

# Risk Management
MAX_POSITION_SIZE_PCT=0.05    # 5% max per position
MAX_DAILY_LOSS_PCT=0.05       # 5% daily loss limit
MAX_DRAWDOWN_PCT=0.15         # 15% max drawdown (kill switch)
DEFAULT_STOP_LOSS_PCT=0.02    # 2% stop loss
DEFAULT_TAKE_PROFIT_PCT=0.05  # 5% take profit

# Trading Symbols (comma-separated)
TRADING_SYMBOLS=AAPL,MSFT,GOOGL,AMZN,META

# Logging
LOG_LEVEL=INFO
LOG_FILE=logs/trading.log

# Notifications (optional)
DISCORD_WEBHOOK_URL=
TELEGRAM_BOT_TOKEN=
TELEGRAM_CHAT_ID=
```

### Strategy Configuration (`config/strategies.yaml`)

```yaml
strategies:
  ma_crossover:
    enabled: true
    params:
      fast_period: 10
      slow_period: 20
      timeframe: "1D"
    symbols:
      - AAPL
      - MSFT
    risk:
      stop_loss_pct: 0.02
      take_profit_pct: 0.05
      position_size_pct: 0.05
```

---

## Running the Bot

### Start Trading Bot

```bash
# Run in foreground
python3 main.py

# Run in background
nohup python3 main.py > bot.log 2>&1 &

# Check if running
ps aux | grep main.py
```

### Expected Output

```
============================================================
AUTO TRADING BOT
Mode: PAPER
Started at: 2026-01-30 00:19:42
============================================================
Initializing trading bot...
Connected to Alpaca (paper)
Market data client initialized
Trading bot initialized successfully
Starting trading loop with 60s interval
Trading symbols: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META']
```

### Stop the Bot

```bash
# Find process ID
ps aux | grep main.py

# Kill process
kill <PID>

# Or use pkill
pkill -f "python3 main.py"
```

### View Logs

```bash
# Real-time logs
tail -f logs/trading.log

# Error logs only
tail -f logs/trading_errors.log
```

---

## Backtesting

### Run a Backtest

```python
from backtest.engine import BacktestEngine
from src.strategy.ma_crossover import MACrossoverStrategy
from src.data.historical import HistoricalDataLoader

# Initialize
loader = HistoricalDataLoader()
strategy = MACrossoverStrategy(fast_period=10, slow_period=20)
engine = BacktestEngine(initial_capital=100000)

# Get historical data
data = loader.get_bars("AAPL", timeframe="1D", limit=500)

# Run backtest
result = engine.run(strategy, data, "AAPL")

# Print results
engine.print_results(result)
```

### Backtest Output

```
============================================================
BACKTEST RESULTS: MA Crossover
============================================================
Symbol: AAPL
Period: 2024-01-15 to 2025-06-24
------------------------------------------------------------
Initial Capital:    $100,000.00
Final Capital:      $112,450.00
Total Return:       $12,450.00 (12.45%)
------------------------------------------------------------
Total Trades:       24
Winning Trades:     15
Losing Trades:      9
Win Rate:           62.50%
Avg Win:            $1,230.00
Avg Loss:           $680.00
Profit Factor:      1.81
------------------------------------------------------------
Max Drawdown:       $8,200.00 (7.30%)
Sharpe Ratio:       1.45
============================================================
```

---

## Risk Management

### Position Sizing

```
Position Size = Portfolio Value × max_position_size_pct × signal_strength

Example:
- Portfolio: $100,000
- Max Position: 5%
- Signal Strength: 0.8
- Position Size: $100,000 × 0.05 × 0.8 = $4,000
```

### Stop-Loss / Take-Profit

```
BUY at $100:
├── Stop-Loss:   $98.00  (-2%)
└── Take-Profit: $105.00 (+5%)
```

### Kill Switch

The kill switch activates when drawdown exceeds 15%, stopping all trading until manually reset.

```python
# Reset kill switch (use with caution)
risk_manager.reset_kill_switch()
```

---

## Project Structure

```
auto-trading-bot/
├── config/
│   ├── settings.py         # Environment configuration
│   └── strategies.yaml     # Strategy parameters
├── src/
│   ├── broker/
│   │   ├── base.py         # Abstract broker interface
│   │   └── alpaca.py       # Alpaca implementation
│   ├── data/
│   │   ├── market_data.py  # Real-time data
│   │   └── historical.py   # Historical data
│   ├── strategy/
│   │   ├── base.py         # Strategy interface
│   │   └── ma_crossover.py # MA Crossover strategy
│   ├── risk/
│   │   └── manager.py      # Risk management
│   ├── execution/
│   │   └── order_manager.py # Order execution
│   └── utils/
│       ├── logger.py       # Logging setup
│       └── notifications.py # Alerts
├── backtest/
│   └── engine.py           # Backtesting framework
├── tests/
├── logs/
├── data/
├── .env                    # API keys (not in git)
├── .env.example            # Template
├── requirements.txt        # Dependencies
├── main.py                 # Entry point
└── README.md               # This file
```

---

## Troubleshooting

### Common Issues

**1. "unauthorized" error**
```
Solution: Check your API keys in .env file
- Ensure no extra spaces or quotes
- Verify keys are for paper/live matching your ENVIRONMENT setting
```

**2. "No data available" for symbol**
```
Solution:
- Check if market is open
- Verify symbol is valid (US stocks only for Alpaca)
- Try fallback to yfinance
```

**3. Bot not executing trades**
```
Check:
- Risk limits not exceeded (daily loss, drawdown)
- Signal strength > 0.5 (threshold for execution)
- Market hours (9:30 AM - 4:00 PM ET)
- Sufficient buying power
```

**4. Kill switch activated**
```python
# Check status
risk_status = risk_manager.get_risk_status(account, positions)
print(risk_status.blocked_reason)

# Reset (careful!)
risk_manager.reset_kill_switch()
```

### Debug Mode

Enable debug logging:
```bash
# In .env
LOG_LEVEL=DEBUG
```

### Manual Testing

```python
# Test broker connection
from src.broker.alpaca import AlpacaBroker
broker = AlpacaBroker(api_key, secret_key, paper=True)
print(broker.connect())  # Should return True
print(broker.get_account())

# Test data fetching
from src.data.historical import HistoricalDataLoader
loader = HistoricalDataLoader(api_key, secret_key)
df = loader.get_bars("AAPL", "1D", limit=10)
print(df)

# Test signal generation
from src.strategy.ma_crossover import MACrossoverStrategy
strategy = MACrossoverStrategy()
signal = strategy.generate_signal(df, "AAPL")
print(f"Signal: {signal.signal_type}, Strength: {signal.strength}")
```

---

## Disclaimer

**This software is for educational purposes only.**

- Trading stocks involves substantial risk of loss
- Past performance does not guarantee future results
- Always test thoroughly with paper trading before using real money
- The authors are not responsible for any financial losses

---

## License

MIT License - See LICENSE file for details.
